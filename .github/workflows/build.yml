name: Build Executables

on:
  # å½“æ¨é€ tag æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰
  push:
    tags:
      - 'v*'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      debug_build:
        description: 'æ„å»ºè°ƒè¯•ç‰ˆæœ¬ï¼ˆä¿ç•™æ§åˆ¶å°ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build ${{ matrix.os }} Executable
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: Windows
            artifact_name: Lunar Eclipse Align Tool.exe
            asset_name: LunarEclipseAlignTool-Windows.exe

          - os: macos-latest
            platform: macOS
            artifact_name: Lunar Eclipse Align Tool.app
            asset_name: LunarEclipseAlignTool-macOS.dmg

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Build with PyInstaller (Windows)
      if: matrix.os == 'windows-latest'
      run: python build.py
      env:
        DEBUG_BUILD: ${{ github.event.inputs.debug_build == 'true' && '1' || '0' }}

    - name: Build with PyInstaller (macOS)
      if: matrix.os == 'macos-latest'
      run: python build.py
      env:
        DEBUG_BUILD: ${{ github.event.inputs.debug_build == 'true' && '1' || '0' }}

    - name: Create DMG (macOS only)
      if: matrix.os == 'macos-latest'
      run: |
        # å®‰è£… create-dmg
        brew install create-dmg

        # åˆ›å»º DMG
        create-dmg \
          --volname "Lunar Eclipse Align Tool" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --app-drop-link 450 185 \
          "dist/${{ matrix.asset_name }}" \
          "dist/${{ matrix.artifact_name }}" || true

        # å¦‚æœ create-dmg å¤±è´¥ï¼Œä½¿ç”¨ hdiutil åˆ›å»ºç®€å• DMG
        if [ ! -f "dist/${{ matrix.asset_name }}" ]; then
          hdiutil create -volname "Lunar Eclipse Align Tool" \
            -srcfolder "dist/${{ matrix.artifact_name }}" \
            -ov -format UDZO \
            "dist/${{ matrix.asset_name }}"
        fi

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=dev-$(date +%Y%m%d)" >> $GITHUB_OUTPUT
        fi

    - name: Upload artifact (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: LunarEclipseAlignTool-${{ matrix.platform }}-${{ steps.get_version.outputs.version }}${{ github.event.inputs.debug_build == 'true' && '-debug' || '' }}
        path: dist/Lunar Eclipse Align Tool.exe
        if-no-files-found: error

    - name: Upload artifact (macOS)
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: LunarEclipseAlignTool-${{ matrix.platform }}-${{ steps.get_version.outputs.version }}${{ github.event.inputs.debug_build == 'true' && '-debug' || '' }}
        path: dist/${{ matrix.asset_name }}
        if-no-files-found: error

    - name: Upload to Release (Windows)
      if: startsWith(github.ref, 'refs/tags/') && matrix.os == 'windows-latest' && github.event.inputs.debug_build != 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/Lunar Eclipse Align Tool.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to Release (macOS)
      if: startsWith(github.ref, 'refs/tags/') && matrix.os == 'macos-latest' && github.event.inputs.debug_build != 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/${{ matrix.asset_name }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/') && github.event.inputs.debug_build != 'true'

    steps:
    - name: Get version
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Update Release Description
      uses: softprops/action-gh-release@v1
      with:
        body: |
          ## æœˆé£Ÿåœ†é¢å¯¹é½å·¥å…· ${{ steps.get_version.outputs.version }}

          ### ä¸‹è½½

          #### Windows
          - ğŸ“¦ [LunarEclipseAlignTool-Windows.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/Lunar%20Eclipse%20Align%20Tool.exe)
          - åŒå‡»è¿è¡Œï¼Œé¦–æ¬¡å¯èƒ½éœ€è¦å…è®¸ Windows Defender

          #### macOS
          - ğŸ“¦ [LunarEclipseAlignTool-macOS.dmg](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.version }}/LunarEclipseAlignTool-macOS.dmg)
          - æ‰“å¼€ DMGï¼Œæ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
          - é¦–æ¬¡è¿è¡Œï¼šå³é”®ç‚¹å‡» â†’ æ‰“å¼€ï¼ˆç»•è¿‡ Gatekeeperï¼‰

          ### ç³»ç»Ÿè¦æ±‚
          - **Windows**: Windows 10/11 64ä½
          - **macOS**: macOS 11 (Big Sur) æˆ–æ›´é«˜ç‰ˆæœ¬

          ### ä¸»è¦åŠŸèƒ½
          - PHD2 å¢å¼ºç®—æ³•ï¼šåŸºäºéœå¤«åœ†æ£€æµ‹
          - å¤š ROI ç²¾é…å‡†ï¼ˆå®éªŒæ€§ï¼‰
          - è‡ªåŠ¨åŒ–æ‰¹å¤„ç†
          - å®æ—¶å‚æ•°è°ƒè¯•

          ### ä½¿ç”¨è¯´æ˜
          è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)

          ---
          ğŸ¤– è‡ªåŠ¨æ„å»º | æ„å»ºç¼–å·: ${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
